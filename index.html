<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>CoreIA - Maya Online</title>
    <style>
        body { background: #000; color: #0f0; font-family: 'Courier New', monospace; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        #log-box { width: 90%; height: 120px; border: 1px solid #0f0; overflow-y: auto; padding: 10px; font-size: 11px; margin-bottom: 10px; background: #050505; }
        #video-container { width: 90%; height: 350px; border: 2px solid #333; background: #111; position: relative; border-radius: 8px; overflow: hidden; }
        .input-area { width: 90%; margin-top: 15px; display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; background: #111; border: 1px solid #0f0; color: #fff; border-radius: 4px; }
        button { padding: 12px 20px; background: #0f0; color: #000; border: none; font-weight: bold; cursor: pointer; border-radius: 4px; }
        button:disabled { background: #333; color: #666; }
    </style>
</head>
<body>

    <h3>ESTADO: <span id="status">INICIALIZANDO...</span></h3>
    <div id="log-box"></div>
    
    <div id="video-container">
        <video id="mediaElement" autoplay playsinline style="width:100%;height:100%;object-fit:cover;"></video>
    </div>

    <div class="input-area">
        <input type="text" id="userInput" placeholder="Escribe a Maya..." disabled>
        <button id="sendBtn" disabled>ENVIAR</button>
    </div>

    <script>
        const log = (m) => {
            const e = document.createElement('div');
            e.innerText = `> ${new Date().toLocaleTimeString()}: ${m}`;
            document.getElementById('log-box').appendChild(e);
            document.getElementById('log-box').scrollTop = 9999;
        };

        const BACKEND_URL = "https://avatar-coreia.onrender.com";
        let sessionId = null;
        let accessToken = null;

        async function init() {
            const status = document.getElementById('status');
            try {
                log("Conectando con el cerebro en la nube...");
                
                // 1. Obtener Token
                const res = await fetch(`${BACKEND_URL}/get-token`);
                if (!res.ok) throw new Error("Fallo al obtener token de Render");
                const data = await res.json();
                accessToken = data.token;
                log("Token validado con éxito.");

                // 2. Crear Sesión en HeyGen
                log("Iniciando sesión en HeyGen...");
                const sessionRes = await fetch("https://api.heygen.com/v1/streaming.new", {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': `Bearer ${accessToken}` 
                    },
                    body: JSON.stringify({ 
                        version: "v2", 
                        avatar_id: "Dexter_v3_public", 
                        voice: { voice_id: "1bd001e8e50b4f73b6414e54290a3739" }
                    })
                });

                const sessionData = await sessionRes.json();
                
                if (!sessionData.data || !sessionData.data.session_id) {
                    const errorMsg = sessionData.error ? sessionData.error.message : "ID de sesión no recibido";
                    throw new Error(errorMsg);
                }
                
                sessionId = sessionData.data.session_id;
                log("Sesión establecida ID: " + sessionId.substring(0,8));
                status.innerText = "ONLINE - MAYA LISTA";
                
                document.getElementById('userInput').disabled = false;
                document.getElementById('sendBtn').disabled = false;

            } catch (e) {
                log("Fallo técnico: " + e.message);
                status.innerText = "ERROR DE SISTEMA";
                console.error("Error detallado:", e);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const text = input.value;
            if(!text || !sessionId) return;

            log(`Tú: ${text}`);
            input.value = "";
            log("Maya procesando...");

            try {
                await fetch("https://api.heygen.com/v1/streaming.task", {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': `Bearer ${accessToken}` 
                    },
                    body: JSON.stringify({ 
                        session_id: sessionId, 
                        text: text, 
                        task_type: "repeat" 
                    })
                });
                log("Respuesta enviada a Maya.");
            } catch (e) {
                log("Error al intentar que Maya hable.");
            }
        }

        document.getElementById('sendBtn').onclick = sendMessage;
        document.getElementById('userInput').onkeypress = (e) => {
            if(e.key === 'Enter') sendMessage();
        };

        window.onload = init;
    </script>
</body>
</html>
